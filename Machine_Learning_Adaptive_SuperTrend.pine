//@version=6
indicator('AI+ML Trading Bot', 'AI+ML Bot', overlay = true, max_labels_count = 500)
import TradingView/ta/7
atr_len = input.int(10, 'ATR Length', group = 'SuperTrend Settings')
fact = input.float(3, 'SuperTrend Factor', group = 'SuperTrend Settings')
training_data_period = input.int(100, 'Training Data Length', group = 'K-Means Settings')
highvol = input.float(0.75, 'Initial High volatility Percentile Guess', maxval = 1, group = 'K-Means Settings', tooltip = 'The initial guess of where the potential \'high volatility\' area is, a value of 0.75 will take the 75th percentile of the range of ATR values over the training data period')
midvol = input.float(0.5, 'Initial Medium volatility Percentile Guess', maxval = 1, group = 'K-Means Settings', tooltip = 'The initial guess of where the potential \'medium volatility\' area is, a value of 0.5 will take the 50th percentile of the range of ATR values over the training data period')
lowvol = input.float(0.25, 'Initial Low volatility Percentile Guess', maxval = 1, group = 'K-Means Settings', tooltip = 'The initial guess of where the potential \'low volatility\' area is, a value of 0.25 will take the 25th percentile of the range of ATR values over the training data period')
t1 = input.int(70, 'Transparency 1', maxval = 100, minval = 0, group = 'Appearance')
t2 = input.int(95, 'Transparency 2', maxval = 100, minval = 0, group = 'Appearance')
green = input.color(#00ffbb, 'Bullish Color', group = 'Appearance')
red = input.color(#ff1100, 'Bearish Color', group = 'Appearance')
strong_green = input.color(#00ff00, 'Strong Bullish Color', group = 'Appearance')
strong_red = input.color(#ff0000, 'Strong Bearish Color', group = 'Appearance')

// Signal Strength Settings
volume_threshold = input.float(1.5, 'Volume Threshold Multiplier', minval = 1.0, group = 'Signal Strength')
rsi_period = input.int(14, 'RSI Period', group = 'Signal Strength')
momentum_period = input.int(14, 'Momentum Period', group = 'Signal Strength')

// Webhook Settings
webhook_url = input.string('https://signals.signum.money/trading', 'Webhook URL', group = 'Webhook Settings')
bot_id = input.string('4vH63Kjr', 'Bot ID', group = 'Webhook Settings')
order_size = input.string('100%', 'Order Size', group = 'Webhook Settings')
enable_webhooks = input.bool(true, 'Enable Webhook Alerts', group = 'Webhook Settings')

// Debug Settings
show_debug_table = input.bool(true, 'Show Debug Table', group = 'Debug Settings')
show_debug_labels = input.bool(false, 'Show Debug Labels', group = 'Debug Settings')
debug_rsi = input.bool(true, 'Debug RSI', group = 'Debug Settings')
debug_volume = input.bool(true, 'Debug Volume', group = 'Debug Settings')
debug_macd = input.bool(true, 'Debug MACD', group = 'Debug Settings')
debug_momentum = input.bool(true, 'Debug Momentum', group = 'Debug Settings')
debug_alerts = input.bool(true, 'Debug Alerts', group = 'Debug Settings')
test_alert = input.bool(false, 'Test Alert (Every 10 bars)', group = 'Debug Settings')

pine_supertrend(factor, atr) =>
    src = hl2
    upperBand = src + factor * atr
    lowerBand = src - factor * atr
    prevLowerBand = nz(lowerBand[1])
    prevUpperBand = nz(upperBand[1])

    lowerBand := lowerBand > prevLowerBand or close[1] < prevLowerBand ? lowerBand : prevLowerBand
    upperBand := upperBand < prevUpperBand or close[1] > prevUpperBand ? upperBand : prevUpperBand
    int _direction = na
    float superTrend = na
    prevSuperTrend = superTrend[1]
    if na(atr[1])
        _direction := 1
        _direction
    else if prevSuperTrend == prevUpperBand
        _direction := close > upperBand ? -1 : 1
        _direction
    else
        _direction := close < lowerBand ? 1 : -1
        _direction
    superTrend := _direction == -1 ? lowerBand : upperBand
    [superTrend, _direction]

volatility = ta.atr(atr_len)

upper = ta.highest(volatility, training_data_period)
lower = ta.lowest(volatility, training_data_period)

high_volatility = lower + (upper - lower) * highvol
medium_volatility = lower + (upper - lower) * midvol
low_volatility = lower + (upper - lower) * lowvol

iterations = 0

size_a = 0
size_b = 0
size_c = 0

hv = array.new_float()
mv = array.new_float()
lv = array.new_float()
amean = array.new_float(1, high_volatility)
bmean = array.new_float(1, medium_volatility)
cmean = array.new_float(1, low_volatility)

if nz(volatility) > 0 and bar_index >= training_data_period - 1

    while (amean.size() == 1 ? true : amean.first() != amean.get(1)) or (bmean.size() == 1 ? true : bmean.first() != bmean.get(1)) or (cmean.size() == 1 ? true : cmean.first() != cmean.get(1))
        hv.clear()
        mv.clear()
        lv.clear()
        for i = training_data_period - 1 to 0 by 1
            _1 = math.abs(volatility[i] - amean.first())
            _2 = math.abs(volatility[i] - bmean.first())
            _3 = math.abs(volatility[i] - cmean.first())
            if _1 < _2 and _1 < _3
                hv.unshift(volatility[i])

            if _2 < _1 and _2 < _3
                mv.unshift(volatility[i])

            if _3 < _1 and _3 < _2
                lv.unshift(volatility[i])

        amean.unshift(hv.avg())
        bmean.unshift(mv.avg())
        cmean.unshift(lv.avg())
        size_a := hv.size()
        size_b := mv.size()
        size_c := lv.size()
        iterations := iterations + 1
        iterations

hv_new = amean.first()
mv_new = bmean.first()
lv_new = cmean.first()
vdist_a = math.abs(volatility - hv_new)
vdist_b = math.abs(volatility - mv_new)
vdist_c = math.abs(volatility - lv_new)

distances = array.new_float()
centroids = array.new_float()

distances.push(vdist_a)
distances.push(vdist_b)
distances.push(vdist_c)

centroids.push(hv_new)
centroids.push(mv_new)
centroids.push(lv_new)

cluster = distances.indexof(distances.min()) // 0 for high, 1 for medium, 2 for low
assigned_centroid = cluster == -1 ? na : centroids.get(cluster)

[ST, dir] = pine_supertrend(fact, assigned_centroid)

// Enhanced Signal Strength Detection
volume_avg = ta.sma(volume, 20)
high_volume = volume > volume_avg * volume_threshold

// Technical indicators for signal strength
rsi = ta.rsi(close, rsi_period)
macd_line = ta.ema(close, 12) - ta.ema(close, 26)
macd_signal = ta.ema(macd_line, 9)
macd_histogram = macd_line - macd_signal

// Additional Moving Averages
sma_10 = ta.sma(close, 10)
sma_20 = ta.sma(close, 20)
sma_50 = ta.sma(close, 50)
sma_100 = ta.sma(close, 100)
sma_200 = ta.sma(close, 200)

// MA is the same as SMA in Pine Script
ma_10 = ta.sma(close, 10)
ma_20 = ta.sma(close, 20)
ma_50 = ta.sma(close, 50)

// Additional EMAs
ema_10 = ta.ema(close, 10)
ema_100 = ta.ema(close, 100)
ema_200 = ta.ema(close, 200)

// Additional technical indicators for #3 features
bb_upper = ta.sma(close, 20) + (ta.stdev(close, 20) * 2)
bb_lower = ta.sma(close, 20) - (ta.stdev(close, 20) * 2)
bb_middle = ta.sma(close, 20)

// Trend confirmation
ema_20 = ta.ema(close, 20)
ema_50 = ta.ema(close, 50)
trend_bullish = ema_20 > ema_50
trend_bearish = ema_20 < ema_50

// Price momentum
price_momentum = close - close[momentum_period]
strong_bullish_momentum = price_momentum > 0 and close > open
strong_bearish_momentum = price_momentum < 0 and close < open

// Additional market conditions for #3 features
price_vs_bb_upper = close > bb_upper
price_vs_bb_lower = close < bb_lower
bb_squeeze = (bb_upper - bb_lower) / bb_middle < 0.1

// Additional signal conditions for #3 features
bb_breakout_bullish = close > bb_upper and close[1] <= bb_upper[1]
bb_breakout_bearish = close < bb_lower and close[1] >= bb_lower[1]
bb_squeeze_condition = bb_squeeze

// ATR for label positioning
atr_7 = ta.atr(7)

// Signal strength conditions
// Strong Buy conditions
strong_buy_condition = ta.crossunder(dir, 0) and (high_volume and rsi < 70 and macd_histogram > 0 or cluster == 2 and strong_bullish_momentum or trend_bullish and rsi > 50 and rsi < 70)

// Regular Buy conditions
buy_condition = ta.crossunder(dir, 0) and not strong_buy_condition

// Strong Sell conditions
strong_sell_condition = ta.crossover(dir, 0) and (high_volume and rsi > 30 and macd_histogram < 0 or cluster == 0 and strong_bearish_momentum or trend_bearish and rsi < 50 and rsi > 30)

// Regular Sell conditions
sell_condition = ta.crossover(dir, 0) and not strong_sell_condition

upTrend = plot(close > ST ? ST : na, color = color.new(green, t1), style = plot.style_linebr) //, force_overlay = true
downTrend = plot(close < ST ? ST : na, color = color.new(red, t1), style = plot.style_linebr, force_overlay = false) //, force_overlay = true
bodyMiddle = plot(barstate.isfirst ? na : (open + close) / 2, 'Body Middle', display = display.none)

fill(bodyMiddle, upTrend, (open + close) / 2, ST, color.new(green, t2), color.new(green, t1))
fill(bodyMiddle, downTrend, ST, (open + close) / 2, color.new(red, t1), color.new(red, t2))

// Enhanced signal shapes with different colors for strength
plotshape(strong_buy_condition and barstate.isconfirmed ? ST : na, 'Strong Buy', shape.labelup, location.absolute, strong_green, text = 'ðŸŸ¢ STRONG BUY', textcolor = color.white, size = size.normal)
plotshape(buy_condition and barstate.isconfirmed ? ST : na, 'Buy', shape.labelup, location.absolute, green, text = 'ðŸŸ¢ BUY', textcolor = color.white, size = size.small)
plotshape(strong_sell_condition and barstate.isconfirmed ? ST : na, 'Strong Sell', shape.labeldown, location.absolute, strong_red, text = 'ðŸ”´ STRONG SELL', textcolor = color.white, size = size.normal)
plotshape(sell_condition and barstate.isconfirmed ? ST : na, 'Sell', shape.labeldown, location.absolute, red, text = 'ðŸ”´ SELL', textcolor = color.white, size = size.small)

label.new(bar_index, dir > 0 ? ST + atr_7 : ST - atr_7, text = str.tostring(4 - (cluster + 1)), style = label.style_none, textcolor = color.from_gradient(cluster + 1, 1, 3, color.new(dir > 0 ? red : green, 30), color.new(dir > 0 ? red : green, 90)))

// Debug Labels
if show_debug_labels and barstate.isconfirmed
    debug_text = ''
    if debug_rsi
        debug_text := debug_text + 'RSI: ' + str.format('{0,number,#.##}', rsi) + '\n'
    if debug_volume
        debug_text := debug_text + 'Vol: ' + (high_volume ? 'HIGH' : 'NORM') + '\n'
    if debug_macd
        debug_text := debug_text + 'MACD: ' + str.format('{0,number,#.##}', macd_histogram) + '\n'
    if debug_momentum
        debug_text := debug_text + 'Mom: ' + str.format('{0,number,#.##}', price_momentum) + '\n'
    debug_text := debug_text + 'Cluster: ' + str.tostring(cluster) + '\n'
    debug_text := debug_text + 'Trend: ' + (trend_bullish ? 'BULL' : trend_bearish ? 'BEAR' : 'NEUT') + '\n'
    
    if strong_buy_condition
        debug_text := debug_text + 'STRONG BUY!'
    else if buy_condition
        debug_text := debug_text + 'BUY'
    else if strong_sell_condition
        debug_text := debug_text + 'STRONG SELL!'
    else if sell_condition
        debug_text := debug_text + 'SELL'
    else
        debug_text := debug_text + 'NO SIGNAL'
    
    label.new(bar_index, high + atr_7, text = debug_text, style = label.style_label_down, color = color.new(color.blue, 80), textcolor = color.white, size = size.small)

// Real-time signal status indicator
if show_debug_table
    var signal_status_table = table.new(position = position.top_center, columns = 1, rows = 2, bgcolor = color.new(color.black, 30), border_width = 2, border_color = color.white, frame_color = color.white, frame_width = 2)
    
    // Current signal status
    current_signal = strong_buy_condition ? 'STRONG BUY' : buy_condition ? 'BUY' : strong_sell_condition ? 'STRONG SELL' : sell_condition ? 'SELL' : 'NO SIGNAL'
    signal_color = strong_buy_condition ? strong_green : buy_condition ? green : strong_sell_condition ? strong_red : sell_condition ? red : color.gray
    
    table.cell(signal_status_table, 0, 0, 'CURRENT SIGNAL', text_color = color.yellow, text_size = size.normal)
    table.cell(signal_status_table, 0, 1, current_signal, text_color = signal_color, text_size = size.large)

// Real-time debug table (updates on every bar)
if show_debug_table
    var debug_table = table.new(position = position.top_left, columns = 2, rows = 15, bgcolor = color.new(color.black, 20), border_width = 1, border_color = color.white, frame_color = color.white, frame_width = 1)
    
    table.cell(debug_table, 0, 0, 'DEBUG INFO', text_color = color.yellow, text_size = size.normal)
    table.cell(debug_table, 1, 0, 'VALUE', text_color = color.yellow, text_size = size.normal)
    
    table.cell(debug_table, 0, 1, 'Current Signal', text_color = color.white)
    signal_text = strong_buy_condition ? 'STRONG BUY' : buy_condition ? 'BUY' : strong_sell_condition ? 'STRONG SELL' : sell_condition ? 'SELL' : 'NO SIGNAL'
    signal_color = strong_buy_condition ? strong_green : buy_condition ? green : strong_sell_condition ? strong_red : sell_condition ? red : color.gray
    table.cell(debug_table, 1, 1, signal_text, text_color = signal_color)
    
    table.cell(debug_table, 0, 2, 'RSI', text_color = color.white)
    table.cell(debug_table, 1, 2, str.format('{0,number,#.##}', rsi), text_color = rsi > 70 ? color.red : rsi < 30 ? color.green : color.white)
    
    table.cell(debug_table, 0, 3, 'MACD Histogram', text_color = color.white)
    table.cell(debug_table, 1, 3, str.format('{0,number,#.##}', macd_histogram), text_color = macd_histogram > 0 ? color.green : color.red)
    
    table.cell(debug_table, 0, 4, 'Volume Status', text_color = color.white)
    table.cell(debug_table, 1, 4, high_volume ? 'HIGH' : 'NORMAL', text_color = high_volume ? color.yellow : color.white)
    
    table.cell(debug_table, 0, 5, 'Price Momentum', text_color = color.white)
    table.cell(debug_table, 1, 5, str.format('{0,number,#.##}', price_momentum), text_color = price_momentum > 0 ? color.green : color.red)
    
    table.cell(debug_table, 0, 6, 'Trend Direction', text_color = color.white)
    trend_text = trend_bullish ? 'BULLISH' : trend_bearish ? 'BEARISH' : 'NEUTRAL'
    trend_color = trend_bullish ? color.green : trend_bearish ? color.red : color.gray
    table.cell(debug_table, 1, 6, trend_text, text_color = trend_color)
    
    table.cell(debug_table, 0, 7, 'Volatility Cluster', text_color = color.white)
    cluster_text = cluster == 0 ? 'HIGH' : cluster == 1 ? 'MEDIUM' : 'LOW'
    cluster_color = cluster == 0 ? color.red : cluster == 1 ? color.yellow : color.green
    table.cell(debug_table, 1, 7, cluster_text, text_color = cluster_color)
    
    table.cell(debug_table, 0, 8, 'SuperTrend Dir', text_color = color.white)
    table.cell(debug_table, 1, 8, dir > 0 ? 'BULLISH' : 'BEARISH', text_color = dir > 0 ? color.green : color.red)
    
    table.cell(debug_table, 0, 9, 'EMA 20 vs 50', text_color = color.white)
    table.cell(debug_table, 1, 9, ema_20 > ema_50 ? 'EMA20 > EMA50' : 'EMA20 < EMA50', text_color = ema_20 > ema_50 ? color.green : color.red)
    
    table.cell(debug_table, 0, 10, 'Volume Ratio', text_color = color.white)
    volume_ratio = volume / volume_avg
    table.cell(debug_table, 1, 10, str.format('{0,number,#.##}x', volume_ratio), text_color = volume_ratio > volume_threshold ? color.yellow : color.white)
    
    table.cell(debug_table, 0, 11, 'ATR (7)', text_color = color.white)
    table.cell(debug_table, 1, 11, str.format('{0,number,#.##}', atr_7), text_color = color.white)
    
    // Alert Debug Information
    if debug_alerts
        table.cell(debug_table, 0, 12, 'Webhooks Enabled', text_color = color.white)
        table.cell(debug_table, 1, 12, enable_webhooks ? 'YES' : 'NO', text_color = enable_webhooks ? color.green : color.red)
        
        table.cell(debug_table, 0, 13, 'Bar Confirmed', text_color = color.white)
        table.cell(debug_table, 1, 13, barstate.isconfirmed ? 'YES' : 'NO', text_color = barstate.isconfirmed ? color.green : color.red)
        
        table.cell(debug_table, 0, 14, 'Alert Ready', text_color = color.white)
        alert_ready = (strong_buy_condition or buy_condition or strong_sell_condition or sell_condition) and barstate.isconfirmed and enable_webhooks
        table.cell(debug_table, 1, 14, alert_ready ? 'YES' : 'NO', text_color = alert_ready ? color.green : color.red)

// Main data table (only on last bar)
if barstate.islast
    var data_table = table.new(position = position.top_right, columns = 4, rows = 4, bgcolor = chart.bg_color, border_width = 1, border_color = chart.fg_color, frame_color = chart.fg_color, frame_width = 1)
    table.cell(data_table, text_halign = text.align_center, column = 0, row = 0, text = 'Cluster Number (Volatility Level)', text_color = chart.fg_color)
    table.cell(data_table, text_halign = text.align_center, column = 1, row = 0, text = 'Cluster Centroid (ATR)', text_color = chart.fg_color)
    table.cell(data_table, text_halign = text.align_center, column = 2, row = 0, text = 'Cluster Size (No. of Data Points in Each Cluster)', text_color = chart.fg_color)
    table.cell(data_table, text_halign = text.align_center, column = 3, row = 0, text = 'Current Volatility', text_color = chart.fg_color)

    table.cell(data_table, text_halign = text.align_center, column = 0, row = 1, text = '3 (High)', text_color = chart.fg_color)
    table.cell(data_table, text_halign = text.align_center, column = 0, row = 2, text = '2 (Medium)', text_color = chart.fg_color)
    table.cell(data_table, text_halign = text.align_center, column = 0, row = 3, text = '1 (Low)', text_color = chart.fg_color)

    table.cell(data_table, text_halign = text.align_center, column = 1, row = 1, text = str.format('{0,number,#.##}', hv_new), text_color = chart.fg_color)
    table.cell(data_table, text_halign = text.align_center, column = 1, row = 2, text = str.format('{0,number,#.##}', mv_new), text_color = chart.fg_color)
    table.cell(data_table, text_halign = text.align_center, column = 1, row = 3, text = str.format('{0,number,#.##}', lv_new), text_color = chart.fg_color)

    table.cell(data_table, text_halign = text.align_center, column = 2, row = 1, text = str.format('{0,number,#.##}', size_c), text_color = chart.fg_color)
    table.cell(data_table, text_halign = text.align_center, column = 2, row = 2, text = str.format('{0,number,#.##}', size_b), text_color = chart.fg_color)
    table.cell(data_table, text_halign = text.align_center, column = 2, row = 3, text = str.format('{0,number,#.##}', size_a), text_color = chart.fg_color)

    table.cell(data_table, text_halign = text.align_center, column = 3, row = 1, text = 'HIGH ' + '(ATR: ' + str.format('{0,number,#.##}', volatility) + ')', text_color = chart.bg_color)
    table.cell(data_table, text_halign = text.align_center, column = 3, row = 2, text = 'MEDIUM ' + '(ATR: ' + str.format('{0,number,#.##}', volatility) + ')', text_color = chart.bg_color)
    table.cell(data_table, text_halign = text.align_center, column = 3, row = 3, text = 'LOW ' + '(ATR: ' + str.format('{0,number,#.##}', volatility) + ')', text_color = chart.bg_color)

    if cluster == 0
        data_table.cell_set_bgcolor(3, 1, chart.fg_color)
    else
        data_table.cell_set_bgcolor(3, 1, chart.bg_color)

    if cluster == 1
        data_table.cell_set_bgcolor(3, 2, chart.fg_color)
    else
        data_table.cell_set_bgcolor(3, 2, chart.bg_color)

    if cluster == 2
        data_table.cell_set_bgcolor(3, 3, chart.fg_color)
    else
        data_table.cell_set_bgcolor(3, 3, chart.bg_color)

////////////////////////////Basic Alerts (Visual Only - No Webhooks)
// These are basic visual alerts for chart notifications only
// Volatility Level Alerts
alertcondition(cluster == 0 and cluster[1] != 0 and barstate.isconfirmed, 'High Volatility Detected', 'Market entered high volatility state')
alertcondition(cluster == 1 and cluster[1] != 1 and barstate.isconfirmed, 'Medium Volatility Detected', 'Market entered medium volatility state')
alertcondition(cluster == 2 and cluster[1] != 2 and barstate.isconfirmed, 'Low Volatility Detected', 'Market entered low volatility state')

////////////////////////////Dynamic Webhook Alerts with Real Values
// These alerts generate dynamic JSON payloads with actual calculated values
// Use these alert names in your webhook settings to get real-time data

// Alert conditions that will show up in the dropdown
// NOTE: These use TradingView placeholders only. For dynamic values, use the alert() function calls below.
alertcondition(strong_buy_condition and barstate.isconfirmed and enable_webhooks, 'ðŸŸ¢ Webhook: Strong Buy', 'Strong buy signal detected with dynamic JSON payload')
alertcondition(buy_condition and barstate.isconfirmed and enable_webhooks, 'ðŸŸ¢ Webhook: Buy', 'Buy signal detected with dynamic JSON payload')
alertcondition(strong_sell_condition and barstate.isconfirmed and enable_webhooks, 'ðŸ”´ Webhook: Strong Sell', 'Strong sell signal detected with dynamic JSON payload')
alertcondition(sell_condition and barstate.isconfirmed and enable_webhooks, 'ðŸ”´ Webhook: Sell', 'Sell signal detected with dynamic JSON payload')

// Visual indicators for webhook alerts
plotshape(strong_buy_condition and barstate.isconfirmed and enable_webhooks, 'ðŸŸ¢ Webhook: Strong Buy', shape.circle, location.belowbar, color.new(color.green, 0), size = size.small)
plotshape(buy_condition and barstate.isconfirmed and enable_webhooks, 'ðŸŸ¢ Webhook: Buy', shape.circle, location.belowbar, color.new(color.green, 0), size = size.tiny)
plotshape(strong_sell_condition and barstate.isconfirmed and enable_webhooks, 'ðŸ”´ Webhook: Strong Sell', shape.circle, location.abovebar, color.new(color.red, 0), size = size.small)
plotshape(sell_condition and barstate.isconfirmed and enable_webhooks, 'ðŸ”´ Webhook: Sell', shape.circle, location.abovebar, color.new(color.red, 0), size = size.tiny)

// Dynamic webhook alerts using alert() function with TradingView placeholders
// Strong Buy Alert with Dynamic Values
if strong_buy_condition and barstate.isconfirmed and enable_webhooks
    webhook_payload = '{"action": "buy", "signal_strength": "strong", "ticker": "{{ticker}}", "order_size": "100%", "position_size": "100%", "schema": "2", "timestamp": "{{time}}", "bot_id": "4vH63Kjr", "price_data": {"close": ' + str.tostring(close) + ', "open": ' + str.tostring(open) + ', "high": ' + str.tostring(high) + ', "low": ' + str.tostring(low) + ', "volume": ' + str.tostring(volume) + '}, "technical_indicators": {"rsi": ' + str.format('{0,number,#.##}', rsi) + ', "macd_line": ' + str.format('{0,number,#.##}', macd_line) + ', "macd_signal": ' + str.format('{0,number,#.##}', macd_signal) + ', "macd_histogram": ' + str.format('{0,number,#.##}', macd_histogram) + ', "sma_10": ' + str.format('{0,number,#.##}', sma_10) + ', "sma_20": ' + str.format('{0,number,#.##}', sma_20) + ', "sma_50": ' + str.format('{0,number,#.##}', sma_50) + ', "sma_100": ' + str.format('{0,number,#.##}', sma_100) + ', "sma_200": ' + str.format('{0,number,#.##}', sma_200) + ', "ma_10": ' + str.format('{0,number,#.##}', ma_10) + ', "ma_20": ' + str.format('{0,number,#.##}', ma_20) + ', "ma_50": ' + str.format('{0,number,#.##}', ma_50) + ', "ema_10": ' + str.format('{0,number,#.##}', ema_10) + ', "ema_20": ' + str.format('{0,number,#.##}', ema_20) + ', "ema_50": ' + str.format('{0,number,#.##}', ema_50) + ', "ema_100": ' + str.format('{0,number,#.##}', ema_100) + ', "ema_200": ' + str.format('{0,number,#.##}', ema_200) + ', "atr": ' + str.format('{0,number,#.##}', volatility) + ', "atr_7": ' + str.format('{0,number,#.##}', atr_7) + ', "bb_upper": ' + str.format('{0,number,#.##}', bb_upper) + ', "bb_lower": ' + str.format('{0,number,#.##}', bb_lower) + ', "bb_middle": ' + str.format('{0,number,#.##}', bb_middle) + '}, "market_conditions": {"volatility_cluster": ' + str.tostring(cluster) + ', "cluster_name": "' + (cluster == 0 ? 'HIGH' : cluster == 1 ? 'MEDIUM' : 'LOW') + '", "trend_direction": "' + (trend_bullish ? 'BULLISH' : trend_bearish ? 'BEARISH' : 'NEUTRAL') + '", "volume_status": "' + (high_volume ? 'HIGH' : 'NORMAL') + '", "price_momentum": ' + str.format('{0,number,#.##}', price_momentum) + ', "supertrend_direction": ' + str.tostring(dir) + ', "supertrend_value": ' + str.format('{0,number,#.##}', ST) + ', "price_vs_bb_upper": ' + str.tostring(price_vs_bb_upper) + ', "price_vs_bb_lower": ' + str.tostring(price_vs_bb_lower) + ', "bb_squeeze": ' + str.tostring(bb_squeeze) + '}, "signal_conditions": {"volume_confirmation": ' + str.tostring(high_volume) + ', "rsi_oversold": ' + str.tostring(rsi < 30) + ', "rsi_overbought": ' + str.tostring(rsi > 70) + ', "macd_bullish": ' + str.tostring(macd_histogram > 0) + ', "trend_alignment": ' + str.tostring(trend_bullish) + ', "momentum_bullish": ' + str.tostring(strong_bullish_momentum) + ', "bb_breakout_bullish": ' + str.tostring(bb_breakout_bullish) + ', "bb_breakout_bearish": ' + str.tostring(bb_breakout_bearish) + ', "bb_squeeze_condition": ' + str.tostring(bb_squeeze_condition) + '}}'
    alert(webhook_payload, alert.freq_once_per_bar)
    if debug_alerts
        label.new(bar_index, high + atr_7 * 2, text = 'ALERT: STRONG BUY WEBHOOK SENT', style = label.style_label_down, color = color.new(color.green, 20), textcolor = color.white, size = size.normal)

// Regular Buy Alert with Dynamic Values
if buy_condition and barstate.isconfirmed and enable_webhooks
    webhook_payload = '{"action": "buy", "signal_strength": "regular", "ticker": "{{ticker}}", "order_size": "' + order_size + '", "position_size": "100%", "schema": "2", "timestamp": "{{time}}", "bot_id": "' + bot_id + '", "price_data": {"close": ' + str.tostring(close) + ', "open": ' + str.tostring(open) + ', "high": ' + str.tostring(high) + ', "low": ' + str.tostring(low) + ', "volume": ' + str.tostring(volume) + '}, "technical_indicators": {"rsi": ' + str.format('{0,number,#.##}', rsi) + ', "macd_line": ' + str.format('{0,number,#.##}', macd_line) + ', "macd_signal": ' + str.format('{0,number,#.##}', macd_signal) + ', "macd_histogram": ' + str.format('{0,number,#.##}', macd_histogram) + ', "sma_10": ' + str.format('{0,number,#.##}', sma_10) + ', "sma_20": ' + str.format('{0,number,#.##}', sma_20) + ', "sma_50": ' + str.format('{0,number,#.##}', sma_50) + ', "sma_100": ' + str.format('{0,number,#.##}', sma_100) + ', "sma_200": ' + str.format('{0,number,#.##}', sma_200) + ', "ma_10": ' + str.format('{0,number,#.##}', ma_10) + ', "ma_20": ' + str.format('{0,number,#.##}', ma_20) + ', "ma_50": ' + str.format('{0,number,#.##}', ma_50) + ', "ema_10": ' + str.format('{0,number,#.##}', ema_10) + ', "ema_20": ' + str.format('{0,number,#.##}', ema_20) + ', "ema_50": ' + str.format('{0,number,#.##}', ema_50) + ', "ema_100": ' + str.format('{0,number,#.##}', ema_100) + ', "ema_200": ' + str.format('{0,number,#.##}', ema_200) + ', "atr": ' + str.format('{0,number,#.##}', volatility) + ', "atr_7": ' + str.format('{0,number,#.##}', atr_7) + '}, "market_conditions": {"volatility_cluster": ' + str.tostring(cluster) + ', "cluster_name": "' + (cluster == 0 ? 'HIGH' : cluster == 1 ? 'MEDIUM' : 'LOW') + '", "trend_direction": "' + (trend_bullish ? 'BULLISH' : trend_bearish ? 'BEARISH' : 'NEUTRAL') + '", "volume_status": "' + (high_volume ? 'HIGH' : 'NORMAL') + '", "price_momentum": ' + str.format('{0,number,#.##}', price_momentum) + ', "supertrend_direction": ' + str.tostring(dir) + ', "supertrend_value": ' + str.format('{0,number,#.##}', ST) + '}, "signal_conditions": {"volume_confirmation": ' + str.tostring(high_volume) + ', "rsi_oversold": ' + str.tostring(rsi < 30) + ', "rsi_overbought": ' + str.tostring(rsi > 70) + ', "macd_bullish": ' + str.tostring(macd_histogram > 0) + ', "trend_alignment": ' + str.tostring(trend_bullish) + ', "momentum_bullish": ' + str.tostring(strong_bullish_momentum) + '}}'
    alert(webhook_payload, alert.freq_once_per_bar)
    if debug_alerts
        label.new(bar_index, high + atr_7 * 2, text = 'ALERT: BUY WEBHOOK SENT', style = label.style_label_down, color = color.new(color.green, 20), textcolor = color.white, size = size.normal)

// Strong Sell Alert with Dynamic Values
if strong_sell_condition and barstate.isconfirmed and enable_webhooks
    webhook_payload = '{"action": "sell", "signal_strength": "strong", "ticker": "{{ticker}}", "order_size": "100%", "position_size": "100%", "schema": "2", "timestamp": "{{time}}", "bot_id": "4vH63Kjr", "price_data": {"close": ' + str.tostring(close) + ', "open": ' + str.tostring(open) + ', "high": ' + str.tostring(high) + ', "low": ' + str.tostring(low) + ', "volume": ' + str.tostring(volume) + '}, "technical_indicators": {"rsi": ' + str.format('{0,number,#.##}', rsi) + ', "macd_line": ' + str.format('{0,number,#.##}', macd_line) + ', "macd_signal": ' + str.format('{0,number,#.##}', macd_signal) + ', "macd_histogram": ' + str.format('{0,number,#.##}', macd_histogram) + ', "sma_10": ' + str.format('{0,number,#.##}', sma_10) + ', "sma_20": ' + str.format('{0,number,#.##}', sma_20) + ', "sma_50": ' + str.format('{0,number,#.##}', sma_50) + ', "sma_100": ' + str.format('{0,number,#.##}', sma_100) + ', "sma_200": ' + str.format('{0,number,#.##}', sma_200) + ', "ma_10": ' + str.format('{0,number,#.##}', ma_10) + ', "ma_20": ' + str.format('{0,number,#.##}', ma_20) + ', "ma_50": ' + str.format('{0,number,#.##}', ma_50) + ', "ema_10": ' + str.format('{0,number,#.##}', ema_10) + ', "ema_20": ' + str.format('{0,number,#.##}', ema_20) + ', "ema_50": ' + str.format('{0,number,#.##}', ema_50) + ', "ema_100": ' + str.format('{0,number,#.##}', ema_100) + ', "ema_200": ' + str.format('{0,number,#.##}', ema_200) + ', "atr": ' + str.format('{0,number,#.##}', volatility) + ', "atr_7": ' + str.format('{0,number,#.##}', atr_7) + ', "bb_upper": ' + str.format('{0,number,#.##}', bb_upper) + ', "bb_lower": ' + str.format('{0,number,#.##}', bb_lower) + ', "bb_middle": ' + str.format('{0,number,#.##}', bb_middle) + '}, "market_conditions": {"volatility_cluster": ' + str.tostring(cluster) + ', "cluster_name": "' + (cluster == 0 ? 'HIGH' : cluster == 1 ? 'MEDIUM' : 'LOW') + '", "trend_direction": "' + (trend_bullish ? 'BULLISH' : trend_bearish ? 'BEARISH' : 'NEUTRAL') + '", "volume_status": "' + (high_volume ? 'HIGH' : 'NORMAL') + '", "price_momentum": ' + str.format('{0,number,#.##}', price_momentum) + ', "supertrend_direction": ' + str.tostring(dir) + ', "supertrend_value": ' + str.format('{0,number,#.##}', ST) + ', "price_vs_bb_upper": ' + str.tostring(price_vs_bb_upper) + ', "price_vs_bb_lower": ' + str.tostring(price_vs_bb_lower) + ', "bb_squeeze": ' + str.tostring(bb_squeeze) + '}, "signal_conditions": {"volume_confirmation": ' + str.tostring(high_volume) + ', "rsi_oversold": ' + str.tostring(rsi < 30) + ', "rsi_overbought": ' + str.tostring(rsi > 70) + ', "macd_bearish": ' + str.tostring(macd_histogram < 0) + ', "trend_alignment": ' + str.tostring(trend_bearish) + ', "momentum_bearish": ' + str.tostring(strong_bearish_momentum) + ', "bb_breakout_bullish": ' + str.tostring(bb_breakout_bullish) + ', "bb_breakout_bearish": ' + str.tostring(bb_breakout_bearish) + ', "bb_squeeze_condition": ' + str.tostring(bb_squeeze_condition) + '}}'
    alert(webhook_payload, alert.freq_once_per_bar)
    if debug_alerts
        label.new(bar_index, low - atr_7 * 2, text = 'ALERT: STRONG SELL WEBHOOK SENT', style = label.style_label_up, color = color.new(color.red, 20), textcolor = color.white, size = size.normal)

// Regular Sell Alert with Dynamic Values
if sell_condition and barstate.isconfirmed and enable_webhooks
    webhook_payload = '{"action": "sell", "signal_strength": "regular", "ticker": "{{ticker}}", "order_size": "' + order_size + '", "position_size": "100%", "schema": "2", "timestamp": "{{time}}", "bot_id": "' + bot_id + '", "price_data": {"close": ' + str.tostring(close) + ', "open": ' + str.tostring(open) + ', "high": ' + str.tostring(high) + ', "low": ' + str.tostring(low) + ', "volume": ' + str.tostring(volume) + '}, "technical_indicators": {"rsi": ' + str.format('{0,number,#.##}', rsi) + ', "macd_line": ' + str.format('{0,number,#.##}', macd_line) + ', "macd_signal": ' + str.format('{0,number,#.##}', macd_signal) + ', "macd_histogram": ' + str.format('{0,number,#.##}', macd_histogram) + ', "sma_10": ' + str.format('{0,number,#.##}', sma_10) + ', "sma_20": ' + str.format('{0,number,#.##}', sma_20) + ', "sma_50": ' + str.format('{0,number,#.##}', sma_50) + ', "sma_100": ' + str.format('{0,number,#.##}', sma_100) + ', "sma_200": ' + str.format('{0,number,#.##}', sma_200) + ', "ma_10": ' + str.format('{0,number,#.##}', ma_10) + ', "ma_20": ' + str.format('{0,number,#.##}', ma_20) + ', "ma_50": ' + str.format('{0,number,#.##}', ma_50) + ', "ema_10": ' + str.format('{0,number,#.##}', ema_10) + ', "ema_20": ' + str.format('{0,number,#.##}', ema_20) + ', "ema_50": ' + str.format('{0,number,#.##}', ema_50) + ', "ema_100": ' + str.format('{0,number,#.##}', ema_100) + ', "ema_200": ' + str.format('{0,number,#.##}', ema_200) + ', "atr": ' + str.format('{0,number,#.##}', volatility) + ', "atr_7": ' + str.format('{0,number,#.##}', atr_7) + '}, "market_conditions": {"volatility_cluster": ' + str.tostring(cluster) + ', "cluster_name": "' + (cluster == 0 ? 'HIGH' : cluster == 1 ? 'MEDIUM' : 'LOW') + '", "trend_direction": "' + (trend_bullish ? 'BULLISH' : trend_bearish ? 'BEARISH' : 'NEUTRAL') + '", "volume_status": "' + (high_volume ? 'HIGH' : 'NORMAL') + '", "price_momentum": ' + str.format('{0,number,#.##}', price_momentum) + ', "supertrend_direction": ' + str.tostring(dir) + ', "supertrend_value": ' + str.format('{0,number,#.##}', ST) + '}, "signal_conditions": {"volume_confirmation": ' + str.tostring(high_volume) + ', "rsi_oversold": ' + str.tostring(rsi < 30) + ', "rsi_overbought": ' + str.tostring(rsi > 70) + ', "macd_bearish": ' + str.tostring(macd_histogram < 0) + ', "trend_alignment": ' + str.tostring(trend_bearish) + ', "momentum_bearish": ' + str.tostring(strong_bearish_momentum) + '}}'
    alert(webhook_payload, alert.freq_once_per_bar)
    if debug_alerts
        label.new(bar_index, low - atr_7 * 2, text = 'ALERT: SELL WEBHOOK SENT', style = label.style_label_up, color = color.new(color.red, 20), textcolor = color.white, size = size.normal)

// Test Alert with Dynamic Values (for debugging)
if test_alert and barstate.isconfirmed and bar_index % 10 == 0
    webhook_payload = '{"action": "buy", "signal_strength": "test", "ticker": "{{ticker}}", "order_size": "' + order_size + '", "position_size": "100%", "schema": "2", "timestamp": "{{time}}", "bot_id": "' + bot_id + '", "price_data": {"close": ' + str.tostring(close) + ', "open": ' + str.tostring(open) + ', "high": ' + str.tostring(high) + ', "low": ' + str.tostring(low) + ', "volume": ' + str.tostring(volume) + '}, "technical_indicators": {"rsi": ' + str.format('{0,number,#.##}', rsi) + ', "macd_line": ' + str.format('{0,number,#.##}', macd_line) + ', "macd_signal": ' + str.format('{0,number,#.##}', macd_signal) + ', "macd_histogram": ' + str.format('{0,number,#.##}', macd_histogram) + ', "sma_10": ' + str.format('{0,number,#.##}', sma_10) + ', "sma_20": ' + str.format('{0,number,#.##}', sma_20) + ', "sma_50": ' + str.format('{0,number,#.##}', sma_50) + ', "sma_100": ' + str.format('{0,number,#.##}', sma_100) + ', "sma_200": ' + str.format('{0,number,#.##}', sma_200) + ', "ma_10": ' + str.format('{0,number,#.##}', ma_10) + ', "ma_20": ' + str.format('{0,number,#.##}', ma_20) + ', "ma_50": ' + str.format('{0,number,#.##}', ma_50) + ', "ema_10": ' + str.format('{0,number,#.##}', ema_10) + ', "ema_20": ' + str.format('{0,number,#.##}', ema_20) + ', "ema_50": ' + str.format('{0,number,#.##}', ema_50) + ', "ema_100": ' + str.format('{0,number,#.##}', ema_100) + ', "ema_200": ' + str.format('{0,number,#.##}', ema_200) + ', "atr": ' + str.format('{0,number,#.##}', volatility) + ', "atr_7": ' + str.format('{0,number,#.##}', atr_7) + '}, "market_conditions": {"volatility_cluster": ' + str.tostring(cluster) + ', "cluster_name": "' + (cluster == 0 ? 'HIGH' : cluster == 1 ? 'MEDIUM' : 'LOW') + '", "trend_direction": "' + (trend_bullish ? 'BULLISH' : trend_bearish ? 'BEARISH' : 'NEUTRAL') + '", "volume_status": "' + (high_volume ? 'HIGH' : 'NORMAL') + '", "price_momentum": ' + str.format('{0,number,#.##}', price_momentum) + ', "supertrend_direction": ' + str.tostring(dir) + ', "supertrend_value": ' + str.format('{0,number,#.##}', ST) + '}, "signal_conditions": {"volume_confirmation": ' + str.tostring(high_volume) + ', "rsi_oversold": ' + str.tostring(rsi < 30) + ', "rsi_overbought": ' + str.tostring(rsi > 70) + ', "macd_bullish": ' + str.tostring(macd_histogram > 0) + ', "trend_alignment": ' + str.tostring(trend_bullish) + ', "momentum_bullish": ' + str.tostring(strong_bullish_momentum) + '}}'
    alert(webhook_payload, alert.freq_once_per_bar)
    if debug_alerts
        label.new(bar_index, high + atr_7 * 3, text = 'TEST ALERT SENT - RSI: ' + str.format('{0,number,#.##}', rsi), style = label.style_label_down, color = color.new(color.blue, 20), textcolor = color.white, size = size.normal)

// Real-time alert status indicator
if show_debug_table
    var alert_status_table = table.new(position = position.top_right, columns = 1, rows = 3, bgcolor = color.new(color.black, 30), border_width = 2, border_color = color.white, frame_color = color.white, frame_width = 2)
    
    // Alert status
    alert_fired = (strong_buy_condition or buy_condition or strong_sell_condition or sell_condition) and barstate.isconfirmed and enable_webhooks
    alert_status = alert_fired ? 'ALERT SENT!' : enable_webhooks ? 'READY' : 'DISABLED'
    alert_status_color = alert_fired ? color.yellow : enable_webhooks ? color.green : color.red
    
    table.cell(alert_status_table, 0, 0, 'ALERT STATUS', text_color = color.yellow, text_size = size.normal)
    table.cell(alert_status_table, 0, 1, alert_status, text_color = alert_status_color, text_size = size.large)
    table.cell(alert_status_table, 0, 2, 'Webhooks: ' + (enable_webhooks ? 'ON' : 'OFF'), text_color = enable_webhooks ? color.green : color.red, text_size = size.small)
